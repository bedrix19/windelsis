!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Windelsis=e():t.Windelsis=e()}(this,(()=>(()=>{"use strict";var t={d:(e,a)=>{for(var i in a)t.o(a,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:a[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};return(()=>{L.DomUtil.setTransform||(L.DomUtil.setTransform=function(t,e,a){var i=e||new L.Point(0,0);t.style[L.DomUtil.TRANSFORM]=(L.Browser.ie3d?"translate("+i.x+"px,"+i.y+"px)":"translate3d("+i.x+"px,"+i.y+"px,0)")+(a?" scale("+a+")":"")}),L.CanvasLayer=(L.Layer?L.Layer:L.Class).extend({initialize:function(t){this._map=null,this._canvas=null,this._frame=null,this._delegate=null,L.setOptions(this,t)},delegate:function(t){return this._delegate=t,this},needRedraw:function(){return this._frame||(this._frame=L.Util.requestAnimFrame(this.drawLayer,this)),this},_onLayerDidResize:function(t){this._canvas.width=t.newSize.x,this._canvas.height=t.newSize.y},_onLayerDidMove:function(){var t=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(this._canvas,t),this.drawLayer()},getEvents:function(){var t={resize:this._onLayerDidResize,moveend:this._onLayerDidMove};return this._map.options.zoomAnimation&&L.Browser.any3d&&(t.zoomanim=this._animateZoom),t},onAdd:function(t){this._map=t,this._canvas=L.DomUtil.create("canvas","leaflet-layer"),this.tiles={};var e=this._map.getSize();this._canvas.width=e.x,this._canvas.height=e.y;var a=this._map.options.zoomAnimation&&L.Browser.any3d;L.DomUtil.addClass(this._canvas,"leaflet-zoom-"+(a?"animated":"hide")),this.options.pane.appendChild(this._canvas),t.on(this.getEvents(),this);var i=this._delegate||this;i.onLayerDidMount&&i.onLayerDidMount(),this.needRedraw();var n=this;setTimeout((function(){n._onLayerDidMove()}),0)},onRemove:function(t){var e=this._delegate||this;e.onLayerWillUnmount&&e.onLayerWillUnmount(),this.options.pane.removeChild(this._canvas),t.off(this.getEvents(),this),this._canvas=null},addTo:function(t){return t.addLayer(this),this},drawLayer:function(){var t=this._map.getSize(),e=this._map.getBounds(),a=this._map.getZoom(),i=this._map.options.crs.project(this._map.getCenter()),n=this._map.options.crs.project(this._map.containerPointToLatLng(this._map.getSize())),o=this._delegate||this;o.onDrawLayer&&o.onDrawLayer({layer:this,canvas:this._canvas,bounds:e,size:t,zoom:a,center:i,corner:n}),this._frame=null},_setTransform:function(t,e,a){var i=e||new L.Point(0,0);t.style[L.DomUtil.TRANSFORM]=(L.Browser.ie3d?"translate("+i.x+"px,"+i.y+"px)":"translate3d("+i.x+"px,"+i.y+"px,0)")+(a?" scale("+a+")":"")},_animateZoom:function(t){var e=this._map.getZoomScale(t.zoom),a=L.Layer?this._map._latLngToNewLayerPoint(this._map.getBounds().getNorthWest(),t.zoom,t.center):this._map._getCenterOffset(t.center)._multiplyBy(-e).subtract(this._map._getMapPanePos());L.DomUtil.setTransform(this._canvas,a,e)}}),L.canvasLayer=function(t){return new L.CanvasLayer(t)},L.Control.Velocity=L.Control.extend({options:{position:"bottomleft",emptyString:"Unavailable",angleConvention:"bearingCCW",showCardinal:!1,speedUnit:"m/s",directionString:"Direction",speedString:"Speed",onAdd:null,onRemove:null},onAdd:function(t){return this._container=L.DomUtil.create("div","leaflet-control-velocity"),L.DomEvent.disableClickPropagation(this._container),t.on("mousemove",this._onMouseMove,this),this.options.leafletVelocity.options.onAdd&&this.options.leafletVelocity.options.onAdd(),this._container},onRemove:function(t){t.off("mousemove",this._onMouseMove,this),this.options.leafletVelocity.options.onRemove&&this.options.leafletVelocity.options.onRemove()},vectorToSpeed:function(t,e,a){var i=Math.sqrt(Math.pow(t,2)+Math.pow(e,2));return"k/h"===a?this.meterSec2kilometerHour(i):"kt"===a?this.meterSec2Knots(i):"mph"===a?this.meterSec2milesHour(i):i},vectorToDegrees:function(t,e,a){a.endsWith("CCW")&&(e=e>0?e=-e:Math.abs(e));var i=Math.sqrt(Math.pow(t,2)+Math.pow(e,2)),n=180*Math.atan2(t/i,e/i)/Math.PI+180;return"bearingCW"!==a&&"meteoCCW"!==a||(n+=180)>=360&&(n-=360),n},degreesToCardinalDirection:function(t){var e="";return t>=0&&t<11.25||t>=348.75?e="N":t>=11.25&&t<33.75?e="NNW":t>=33.75&&t<56.25?e="NW":t>=56.25&&t<78.75?e="WNW":t>=78.25&&t<101.25?e="W":t>=101.25&&t<123.75?e="WSW":t>=123.75&&t<146.25?e="SW":t>=146.25&&t<168.75?e="SSW":t>=168.75&&t<191.25?e="S":t>=191.25&&t<213.75?e="SSE":t>=213.75&&t<236.25?e="SE":t>=236.25&&t<258.75?e="ESE":t>=258.75&&t<281.25?e="E":t>=281.25&&t<303.75?e="ENE":t>=303.75&&t<326.25?e="NE":t>=326.25&&t<348.75&&(e="NNE"),e},meterSec2Knots:function(t){return t/.514},meterSec2kilometerHour:function(t){return 3.6*t},meterSec2milesHour:function(t){return 2.23694*t},_onMouseMove:function(t){var e=this.options.leafletVelocity._map.containerPointToLatLng(L.point(t.containerPoint.x,t.containerPoint.y));this.options.leafletVelocity._windy.interpolatePoint(e.lng,e.lat);this._container.innerHTML=""}}),L.Map.mergeOptions({positionControl:!1}),L.Map.addInitHook((function(){this.options.positionControl&&(this.positionControl=new L.Control.MousePosition,this.addControl(this.positionControl))})),L.control.velocity=function(t){return new L.Control.Velocity(t)},L.VelocityLayer=(L.Layer?L.Layer:L.Class).extend({options:{displayValues:!0,displayOptions:{velocityType:"Velocity",position:"bottomleft",emptyString:"No velocity data"},maxVelocity:10,colorScale:null,data:null},_map:null,_canvasLayer:null,_windy:null,_context:null,_timer:0,_mouseControl:null,initialize:function(t){L.setOptions(this,t)},onAdd:function(t){this._paneName=this.options.paneName||"overlayPane";var e=t._panes.overlayPane;t.getPane&&((e=t.getPane(this._paneName))||(e=t.createPane(this._paneName))),this._canvasLayer=L.canvasLayer({pane:e}).delegate(this),this._canvasLayer.addTo(t),this._map=t},onRemove:function(t){this._destroyWind()},setData:function(t){this.options.data=t,this._windy&&(this._windy.setData(t),this._clearAndRestart()),this.fire("load")},setOpacity:function(t){this._canvasLayer.setOpacity(t)},setOptions:function(t){this.options=Object.assign(this.options,t),t.hasOwnProperty("displayOptions")&&(this.options.displayOptions=Object.assign(this.options.displayOptions,t.displayOptions),this._initMouseHandler(!0)),t.hasOwnProperty("data")&&(this.options.data=t.data),this._windy&&(this._windy.setOptions(t),t.hasOwnProperty("data")&&this._windy.setData(t.data),this._clearAndRestart()),this.fire("load")},onDrawLayer:function(t,e){var a=this;this._windy?this.options.data&&(this._timer&&clearTimeout(a._timer),this._timer=setTimeout((function(){a._startWindy()}),750)):this._initWindy(this)},_startWindy:function(){var t=this._map.getBounds(),e=this._map.getSize();this.options.data[0].header.la1,this.options.data[0].header.la2,this.options.data[0].header.lo1,this.options.data[0].header.lo2;this._windy.start([[0,0],[e.x,e.y]],e.x,e.y,[[t._southWest.lng,t._southWest.lat],[t._northEast.lng,t._northEast.lat]])},_updateWindDuringDrag:function(){this._dragTimer&&clearTimeout(this._dragTimer),this._dragTimer=setTimeout((()=>{this._clearAndRestart()}),200)},_initWindy:function(e){var a=Object.assign({canvas:e._canvasLayer._canvas,map:this._map},e.options);this._windy=new t(a),this._context=this._canvasLayer._canvas.getContext("2d"),this._canvasLayer._canvas.classList.add("velocity-overlay"),this.onDrawLayer(),this._map.on("drag",(t=>e._updateWindDuringDrag())),this._map.on("zoomstart",e._windy.stop),this._map.on("zoomend",e._clearAndRestart),this._map.on("resize",e._clearWind),this._initMouseHandler(!1)},_initMouseHandler:function(t){if(t&&(this._map.removeControl(this._mouseControl),this._mouseControl=!1),!this._mouseControl&&this.options.displayValues){var e=this.options.displayOptions||{};e.leafletVelocity=this,this._mouseControl=L.control.velocity(e).addTo(this._map)}},_clearAndRestart:function(){this._context&&this._context.clearRect(0,0,3e3,3e3),this._windy&&this._startWindy()},_clearWind:function(){this._windy&&this._windy.stop(),this._context&&this._context.clearRect(0,0,3e3,3e3)},_destroyWind:function(){this._timer&&clearTimeout(this._timer),this._windy&&this._windy.stop(),this._context&&this._context.clearRect(0,0,3e3,3e3),this._mouseControl&&this._map.removeControl(this._mouseControl),this._mouseControl=null,this._windy=null,this._map.removeLayer(this._canvasLayer)}}),L.velocityLayer=function(t){return new L.VelocityLayer(t)};var t=function(t){var e,a,i,n,o,r,s,l,d,h,p=t.minVelocity||0,c=t.maxVelocity||10,u=(t.velocityScale||.005)*(Math.pow(window.devicePixelRatio,1/3)||1),m=t.particleAge||90,y=t.lineWidth||1,g=t.particleMultiplier||1/300,_=Math.pow(window.devicePixelRatio,1/3)||1.6,f=t.frameRate||15,v=1e3/f,w=.97,M=t.colorScale||["rgb(36,104, 180)","rgb(60,157, 194)","rgb(128,205,193 )","rgb(151,218,168 )","rgb(198,231,181)","rgb(238,247,217)","rgb(255,238,159)","rgb(252,217,125)","rgb(255,182,100)","rgb(252,150,75)","rgb(250,112,52)","rgb(245,64,32)","rgb(237,45,28)","rgb(220,24,32)","rgb(180,0,35)"],D=[NaN,NaN,null],b=t.data,x=function(t,e,a,i,n,o){var r=1-t,s=1-e,l=r*s,d=t*s,h=r*e,p=t*e,c=a[0]*l+i[0]*d+n[0]*h+o[0]*p,u=a[1]*l+i[1]*d+n[1]*h+o[1]*p;return[c,u,Math.sqrt(c*c+u*u)]},P=function(t){var e=null,a=null;return t.forEach((function(t){switch(t.header.parameterCategory+","+t.header.parameterNumber){case"1,2":case"2,2":e=t;break;case"1,3":case"2,3":a=t;break;default:0}})),function(t,e){var a=t.data,i=e.data;return{header:t.header,data:function(t){return[a[t],i[t]]},interpolate:x}}(e,a)},C=function(t,i){if(!a)return null;var l,d=T(t-n,360)/r,h=(o-i)/s,p=Math.floor(d),c=p+1,u=Math.floor(h),m=u+1;if(l=a[u]){var y=l[p],g=l[c];if(W(y)&&W(g)&&(l=a[m])){var _=l[p],f=l[c];if(W(_)&&W(f))return e.interpolate(d-p,h-u,y,g,_,f)}}return null},W=function(t){return null!=t},T=function(t,e){return t-e*Math.floor(t/e)},S=function(t,e,a,i,n,o,r){var s=r[0]*o,l=r[1]*o,d=N(t,e,a,i,n);return r[0]=d[0]*s+d[2]*l,r[1]=d[1]*s+d[3]*l,r},N=function(t,e,a,i,n){var o=2*Math.PI,r=e<0?5:-5,s=a<0?5:-5,l=R(a,e+r),d=R(a+s,e),h=Math.cos(a/360*o);return[(l[0]-i)/r/h,(l[1]-n)/r/h,(d[0]-i)/s,(d[1]-n)/s]},z=function(t,e,a){function i(e,a){var i=t[Math.round(e)];return i&&i[Math.round(a)]||D}i.release=function(){t=[]},i.randomize=function(t){var a,n,o=0;do{a=Math.round(Math.floor(Math.random()*e.width)+e.x),n=Math.round(Math.floor(Math.random()*e.height)+e.y)}while(null===i(a,n)[2]&&o++<30);return t.x=a,t.y=n,t},a(e,i)},E=function(t){return t/180*Math.PI},O=function(e,a,i){var n=t.map.containerPointToLatLng(L.point(e,a));return[n.lng,n.lat]},R=function(e,a,i){var n=t.map.latLngToContainerPoint(L.latLng(e,a));return[n.x,n.y]},$=function(e,a){var i,n,o=(i=p,n=c,M.indexFor=function(t){return Math.max(0,Math.min(M.length-1,Math.round((t-i)/(n-i)*(M.length-1))))},M),r=o.map((function(){return[]})),s=Math.round(e.width*e.height*g);/android|blackberry|iemobile|ipad|iphone|ipod|opera mini|webos/i.test(navigator.userAgent)&&(s*=_);for(var l="rgba(0, 0, 0, ".concat(w,")"),d=[],u=0;u<s;u++)d.push(a.randomize({age:Math.floor(Math.random()*m)+0}));var f=t.canvas.getContext("2d");f.lineWidth=y,f.fillStyle=l,f.globalAlpha=.6;var L=Date.now();!function t(){h=requestAnimationFrame(t);var i=Date.now(),n=i-L;n>v&&(L=i-n%v,r.forEach((function(t){t.length=0})),d.forEach((function(t){t.age>m&&(a.randomize(t).age=0);var e=t.x,i=t.y,n=a(e,i),s=n[2];if(null===s)t.age=m;else{var l=e+n[0],d=i+n[1];null!==a(l,d)[2]?(t.xt=l,t.yt=d,r[o.indexFor(s)].push(t)):(t.x=l,t.y=d)}t.age+=1})),f.globalCompositeOperation="destination-in",f.fillRect(e.x,e.y,e.width,e.height),f.globalCompositeOperation="lighter",f.globalAlpha=0===w?0:.9*w,r.forEach((function(t,e){t.length>0&&(f.beginPath(),f.strokeStyle=o[e],t.forEach((function(t){f.moveTo(t.x,t.y),f.lineTo(t.xt,t.yt),t.x=t.xt,t.y=t.yt})),f.stroke())})))}()},A=function(){B.field&&B.field.release(),h&&cancelAnimationFrame(h)},B={params:t,start:function(t,h,p,c){var m={south:E(c[0][1]),north:E(c[1][1]),east:E(c[1][0]),west:E(c[0][0]),width:h,height:p};A(),function(t,h){var p=!0;t.length<2&&(p=!1),p||console.log("Windy Error: data must have at least two components (u,v)");var c=(e=P(t)).header;if(c.hasOwnProperty("gridDefinitionTemplate")&&0!=c.gridDefinitionTemplate&&(p=!1),p||console.log("Windy Error: Only data with Latitude_Longitude coordinates is supported"),p=!0,n=c.lo1,o=c.la1,r=c.dx,s=c.dy,l=c.nx,d=c.ny,c.hasOwnProperty("scanMode")){var u=c.scanMode.toString(2),m=(u=("0"+u).slice(-8)).split("").map(Number).map(Boolean);m[0]&&(r=-r),m[1]&&(s=-s),m[2]&&(p=!1),m[3]&&(p=!1),m[4]&&(p=!1),m[5]&&(p=!1),m[6]&&(p=!1),m[7]&&(p=!1),p||console.log("Windy Error: Data with scanMode: "+c.scanMode+" is not supported.")}(i=new Date(c.refTime)).setHours(i.getHours()+c.forecastTime),a=[];for(var y=0,g=Math.floor(l*r)>=360,_=0;_<d;_++){for(var f=[],v=0;v<l;v++,y++)f[v]=e.data(y);g&&f.push(f[0]),a[_]=f}h({date:i,interpolate:C})}(b,(function(e){!function(t,e,a,i){var n={},o=(a.south-a.north)*(a.west-a.east),r=u*Math.pow(o,.4),s=[],l=e.x;function d(a){for(var i=[],o=e.y;o<=e.yMax;o+=2){var l=O(a,o);if(l){var d=l[0],h=l[1];if(isFinite(d)){var p=t.interpolate(d,h);p&&(p=S(n,d,h,a,o,r,p),i[o+1]=i[o]=p)}}}s[a+1]=s[a]=i}!function t(){for(var a=Date.now();l<e.width;)if(d(l),l+=2,Date.now()-a>1e3)return void setTimeout(t,25);z(s,e,i)}()}(e,function(t,e,a){var i=t[0],n=t[1],o=Math.round(i[0]),r=Math.max(Math.floor(i[1],0),0);return Math.min(Math.ceil(n[0],e),e-1),{x:o,y:r,xMax:e,yMax:Math.min(Math.ceil(n[1],a),a-1),width:e,height:a}}(t,h,p),m,(function(t,e){B.field=e,$(t,e)}))}))},stop:A,createField:z,interpolatePoint:C,setData:function(t){b=t},setOptions:function(t){t.hasOwnProperty("minVelocity")&&(p=t.minVelocity),t.hasOwnProperty("maxVelocity")&&(c=t.maxVelocity),t.hasOwnProperty("velocityScale")&&(u=(t.velocityScale||.005)*(Math.pow(window.devicePixelRatio,1/3)||1)),t.hasOwnProperty("particleAge")&&(m=t.particleAge),t.hasOwnProperty("lineWidth")&&(y=t.lineWidth),t.hasOwnProperty("particleMultiplier")&&(g=t.particleMultiplier),t.hasOwnProperty("opacity")&&(w=+t.opacity),t.hasOwnProperty("frameRate")&&(f=t.frameRate),v=1e3/f}};return B};window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})})(),(()=>{function a(t,e){if(t<=e[0].value){const[t,a,i]=e[0].color;return{r:t,g:a,b:i}}if(t>=e[e.length-1].value){const[t,a,i]=e[e.length-1].color;return{r:t,g:a,b:i}}for(let a=0;a<e.length-1;a++){const i=e[a],n=e[a+1];if(t>=i.value&&t<=n.value){const e=(t-i.value)/(n.value-i.value);return{r:Math.round(i.color[0]+e*(n.color[0]-i.color[0])),g:Math.round(i.color[1]+e*(n.color[1]-i.color[1])),b:Math.round(i.color[2]+e*(n.color[2]-i.color[2]))}}}}t.r(e),t.d(e,{MapManager:()=>p});const i={temperature:[{value:-15,color:[113,190,207]},{value:-8,color:[137,204,197]},{value:-4,color:[120,184,206]},{value:0,color:[98,129,207]},{value:1,color:[128,167,132]},{value:10,color:[181,202,96]},{value:21,color:[242,177,59]},{value:30,color:[235,96,49]},{value:47,color:[112,45,21]}],precipitation:[{value:0,color:[255,255,255]},{value:1,color:[200,255,255]},{value:5,color:[100,200,255]},{value:10,color:[0,100,255]},{value:25,color:[0,0,255]},{value:50,color:[128,0,255]}]};class n{constructor(t,e,a={}){this.map=t,this.data=e,this.canvasLayer=null,this._timer=null,this.options=Object.assign({pixelSize:5,opacity:.3,controlName:"Data Layer",layerControl:t.layerControl,colorScale:i.temperature,demoMode:!1},a)}init(){this._paneName=this.options.paneName||"overlayPane";var t=this.map._panes.overlayPane;return this.map.getPane&&((t=this.map.getPane(this._paneName))||(t=this.map.createPane(this._paneName))),this.canvasLayer=L.canvasLayer({pane:t}).delegate(this),this.options.layerControl.addOverlay(this.canvasLayer,this.options.controlName),this.canvasLayer}onDrawLayer(t){this.data&&this.data.data&&0!==this.data.data.length?(this._timer&&clearTimeout(this._timer),this._timer=setTimeout((()=>{const e=t.canvas.getContext("2d");e.clearRect(0,0,t.canvas.width,t.canvas.height),e.globalAlpha=this.options.opacity,e.globalCompositeOperation="multiply";const i=t.canvas.width,n=t.canvas.height,o=e.getImageData(0,0,i,n),r=o.data;for(let t=0;t<n;t++)for(let e=0;e<i;e++){const n=this.map.containerPointToLatLng([e,t]),o=this.interpolateValue(n.lat,n.lng),{r:s,g:l,b:d}=a(o,this.options.colorScale),h=Math.floor(255*this.options.opacity),p=4*(t*i+e);r[p]=s,r[p+1]=l,r[p+2]=d,r[p+3]=h}if(this.options.demoMode){const t=this.data.header,e=t.nx,a=t.ny,o=t.dx,s=t.dy,l=t.lo1,d=t.la1;for(let t=0;t<a;t++)for(let a=0;a<e;a++){const e=d-t*s,h=l+a*o,p=this.map.latLngToContainerPoint([e,h]),c=Math.round(p.x),u=Math.round(p.y);if(c>=0&&c<i&&u>=0&&u<n){const t=4*(u*i+c);r[t]=0,r[t+1]=0,r[t+2]=0,r[t+3]=255}}}e.putImageData(o,0,0)}),100)):console.log(this.data,"No hay datos disponibles para dibujar")}interpolateValue(t,e){const{header:a,data:i}=this.data,{lo1:n,lo2:o,la1:r,la2:s,nx:l,ny:d,dx:h,dy:p}=a,c=Math.floor((r-t)/p),u=Math.floor((e-n)/h);if(c<0||c>=d-1||u<0||u>=l-1)return null;const m=i[c*l+u],y=i[c*l+(u+1)],g=i[(c+1)*l+u],_=n+u*h,f=n+(u+1)*h,v=r-c*p,w=m+(y-m)*(e-_)/(f-_);return w+(g+(i[(c+1)*l+(u+1)]-g)*(e-_)/(f-_)-w)*(t-v)/(r-(c+1)*p-v)}update(t){this.data=t,this.canvasLayer&&this.canvasLayer.needRedraw()}_clearTemperature(){if(this.canvasLayer&&this.canvasLayer._canvas){this.canvasLayer._canvas.getContext("2d").clearRect(0,0,this.canvasLayer._canvas.width,this.canvasLayer._canvas.height)}}_destroyTemperatureLayer(){this._timer&&clearTimeout(this._timer),this._clearTemperature(),this.canvasLayer&&(this.map.removeLayer(this.canvasLayer),this.canvasLayer=null)}}class o{constructor(t,e){this.latitude=t,this.longitude=e,this.id=d.generatePointKey(t,e),this.weatherData={weather_units:{temperature:"°C",wind_speed:"m/s",wind_direction:"°",precipitation:"mm",precipitation_prob:"%"},temperature:null,wind:{speed:null,direction:null},precipitation:null,precipitation_prob:null,timestamp:null,rawData:null},this.windComponents={u:null,v:null}}setWeatherData(t){if(this.weatherData={...t,temperature:t.temperature??0,wind:{speed:t.wind?.speed??0,direction:t.wind?.direction??0},precipitation:t.precipitation??0,precipitation_prob:t.precipitation_prob??0,timestamp:t.timestamp??null,rawData:t.rawData??null},null!==this.weatherData.wind.speed&&null!==this.weatherData.wind.direction){const{u:t,v:e}=d.convertWindDirection(this.weatherData.wind.speed,this.weatherData.wind.direction);this.windComponents.u=t,this.windComponents.v=e}}convertSpeed(t,e){return"km/h"===e?.27778*t:t}getTemperature(){return this.weatherData.temperature}getPrecipitation(){return this.weatherData.precipitation}getWindSpeed(){return this.weatherData.wind?.speed}getWindDirection(){return this.weatherData.wind?.direction}getWindComponents(){return this.windComponents}isStale(){if(!this.weatherData.timestamp)return!0;const t=new Date(Date.now()-36e5);return this.weatherData.timestamp<t}toString(){return`la:${this.latitude}, lo:${this.longitude}\nTemperature: ${this.weatherData.temperature}°C\nWind: speed ${this.weatherData.wind.speed}m/s | direction ${this.weatherData.wind.direction}°\nComponents: u ${this.u}m/s | v ${this.v}m/s)`}}function r(t,e="temperature"){const{bounds:a,dx:i,dy:n,nx:r,ny:l,gridPointsMap:d}=t;let h=a.getSouthWest().lat,p=a.getNorthWest().lat,c=a.getSouthWest().lng,u=a.getSouthEast().lng,m=[];for(let t=0;t<l;t++){let e=p-t*n;for(let t=0;t<r;t++){let a=c+t*i;if(e<h||a>u)continue;const n=s(e,a);let r=d.has(n)?d.get(n):new o(e,a);m.push(r)}}var y=[];for(let t=0;t<m.length;t++){const a="temperature"===e?m[t].getTemperature():m[t].getPrecipitation();y.push(a)}return{header:{lo1:a.getNorthWest().lng,lo2:a.getSouthEast().lng,la1:a.getNorthWest().lat,la2:a.getSouthEast().lat,nx:r,ny:l,dx:i,dy:n},data:y}}function s(t,e,a=4){return`${t.toFixed(a)}_${e.toFixed(a)}`}function l(t,e=.0625){const a=Math.abs(t.getNorthEast().lng-t.getSouthWest().lng),i=Math.abs(t.getNorthEast().lat-t.getSouthWest().lat);for(let t=0;t<16&&!(i<=.0625*t||a<=.0625*t);t++);return{nx:Math.ceil(a/e)+1,ny:Math.ceil(i/e)+1,dx:e,dy:e}}const d={generateRandomGridData:function(t){const e=20*Math.random()+5,a=10*Math.random()+5,i=360*Math.random(),n=5*Math.random();(t instanceof Map?Array.from(t.values()):t).forEach((t=>{const o=(e+(10*Math.random()-5)).toFixed(2),r=(a+(5*Math.random()-2.5)).toFixed(2),s=(i+(180*Math.random()-45)).toFixed(2),l=(n+(2*Math.random()-1)).toFixed(2),d={weather_units:{temperature:"°C",wind_speed:"m/s",wind_direction:"°",precipitation:"mm"},temperature:parseFloat(o),wind:{speed:parseFloat(r),direction:parseFloat(s)},precipitation:parseFloat(l),timestamp:(new Date).toISOString(),rawData:null};t.setWeatherData(d)}))},convertWindDirection:function(t,e){const a=e*(Math.PI/180);return{u:-t*Math.sin(a),v:-t*Math.cos(a)}},getBoundsAtZoom:function(t,e){const a=t.getCenter(),i=t.getPixelBounds(a,e),n=t.unproject(i.getBottomLeft(),e),o=t.unproject(i.getTopRight(),e);return L.latLngBounds(n,o)},calculateOptimalPointDistance:function(t,e=150){const a=[.0625,.125,.25,.5,1],i=Math.abs(t.getNorthEast().lng-t.getSouthWest().lng),n=Math.abs(t.getNorthEast().lat-t.getSouthWest().lat);for(const t of a){const a=Math.ceil(i/t)+1,o=Math.ceil(n/t)+1,r=a*o;if(r<=e)return console.log(`Selected point distance: ${t}° (${a}x${o}=${r} points)`),t;console.log(`Distance ${t}° would exceed maxPoints (${r} > ${e})`)}return console.log("Using maximum distance: 1° due to area size"),a[a.length-1]},getMapBoundsCoordinates:function(t,e=0){const a=.5,i=t.getBounds();var n=i.getSouthWest(),o=i.getNorthEast();function r(t,e,a){return a?Math.ceil(t/e)*e:Math.floor(t/e)*e}return n=L.latLng(r(n.lat,a,!1)-e,r(n.lng,a,!1)-e),o=L.latLng(r(o.lat,a,!0)+e,r(o.lng,a,!0)+e),L.latLngBounds(n,o)},weatherDataBuilder:r,tempDataBuilder:function(t){return r(t,"temperature")},precipDataBuilder:function(t){return r(t,"precipitation")},windyDataBuilder:function(t,e){const{bounds:a,dx:i,dy:n,nx:r,ny:l,gridPointsMap:d}=t;e.dateType,e.hour_index;let h=a.getSouthWest().lat,p=a.getNorthWest().lat,c=a.getSouthWest().lng,u=a.getSouthEast().lng,m=[];for(let t=0;t<l;t++){let e=p-t*n;for(let t=0;t<r;t++){let a=c+t*i;if(e<h||a>u)continue;const n=s(e,a);let r=d.has(n)?d.get(n):new o(e,a);m.push(r)}}var y=[],g=[];for(let t=0;t<m.length;t++){const{u:e,v:a}=m[t].getWindComponents();y.push(e),g.push(a)}return[{header:{parameterUnit:"m.s-1",parameterNumberName:"eastward_wind",parameterCategory:2,parameterNumber:2,lo1:a.getNorthWest().lng,lo2:a.getSouthEast().lng,la1:a.getNorthWest().lat,la2:a.getSouthEast().lat,nx:r,ny:l,dx:i,dy:n},data:y},{header:{parameterUnit:"m.s-1",parameterNumberName:"northward_wind",parameterCategory:2,parameterNumber:3,lo1:a.getNorthWest().lng,lo2:a.getSouthEast().lng,la1:a.getNorthWest().lat,la2:a.getSouthEast().lat,nx:r,ny:l,dx:i,dy:n},data:g}]},generatePointKey:s,buildPointsLookup:function(t){const e=new Map;return t.forEach((t=>{const a=s(t.latitude,t.longitude);e.set(a,t)})),e},calculateGridParameters:l,gridBuilder:function(t,e,a,i,n){n&&(console.log("northWest",a.getNorthWest()),L.marker(a.getNorthWest()).addTo(t),console.log("northEast",a.getNorthEast()),L.marker(a.getNorthEast()).addTo(t),console.log("southWest",a.getSouthWest()),L.marker(a.getSouthWest()).addTo(t),console.log("southEast",a.getSouthEast()),L.marker(a.getSouthEast()).addTo(t));const{nx:r,ny:d,dx:h,dy:p}=l(a,e);n&&console.log("nx:",r,"ny:",d,"dx:",h,"dy:",p);const c=[];let u=0,m=0;for(let t=0;t<d;t++){const e=a.getNorthWest().lat-t*p;for(let t=0;t<r;t++){const n=a.getNorthWest().lng+t*h,r=s(e,n);let l=i.get(r);l||(l=new o(e,n),i.set(r,l),c.push(l),u++),m++}}return n&&(console.log("Puntos generados:",u),console.log("Puntos obviados:",m-u)),{bounds:a,grid:c,gridPointsMap:i,dx:h,dy:p,nx:r,ny:d}},updateWindyParameters:function(t=null,e){t&&t.setOptions(e)}};async function h(t,e){const a=new Array(t.length),i=[];for(let a=0;a<t.length;a+=100){const n=t.slice(a,a+100),o=n.map((t=>t.latitude)).join(","),r=n.map((t=>t.longitude)).join(","),s="https://api.open-meteo.com/v1/forecast";let l="";switch(e.dateType){case"current":l=`${s}?latitude=${o}&longitude=${r}&current=temperature_2m,wind_speed_10m,wind_direction_10m,precipitation,precipitation_probability&wind_speed_unit=ms`;break;case"forecast":l=`${s}?latitude=${o}&longitude=${r}&start_date=${e.start_date}&end_date=${e.end_date}&daily=temperature_2m_max,precipitation_sum,wind_speed_10m_max,wind_direction_10m_dominant,precipitation_probability_max&wind_speed_unit=ms`;break;case"forecast_hourly":l=`${s}?latitude=${o}&longitude=${r}&start_date=${e.start_date}&end_date=${e.end_date}&hourly=temperature_2m,precipitation,wind_speed_10m,wind_direction_10m,precipitation_probability&wind_speed_unit=ms`;break;default:throw new Error("Invalid date type")}console.log("Calling URL:",l),i.push(fetch(l).then((t=>{if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t.json()})).then((t=>({data:t,startIndex:a}))))}return(await Promise.all(i)).forEach((({data:t,startIndex:i})=>{(Array.isArray(t)?t:[t]).forEach(((t,n)=>{a[i+n]=function(t,e){if(!t||!t.current&&!t.hourly&&!t.daily)throw new Error("Invalid data format");const a=(e,a=0)=>{const i=t[e],n=t[`${e}_units`];return{temperature:i.temperature_2m_max?.[a]??i.temperature_2m?.[a]??i.temperature_2m,wind:{speed:i.wind_speed_10m_max?.[a]??i.wind_speed_10m?.[a]??i.wind_speed_10m,direction:i.wind_direction_10m_dominant?.[a]??i.wind_direction_10m?.[a]??i.wind_direction_10m},precipitation:i.precipitation_sum?.[a]??i.precipitation?.[a]??i.precipitation,precipitation_prob:i.precipitation_probability_max?.[a]??i.precipitation_probability?.[a]??i.precipitation_probability,weatherUnits:{temperature:n.temperature_2m_max??n.temperature_2m,windSpeed:n.wind_speed_10m_max??n.wind_speed_10m,windDirection:n.wind_direction_10m_dominant??n.wind_direction_10m,precipitation:n.precipitation_sum??n.precipitation,precipitationProb:n.precipitation_probability_max??n.precipitation_probability??"%"},timestamp:i.time?.[a]??i.time,rawData:t}};switch(e.dateType){case"current":return a("current");case"forecast":return a("daily",0);case"forecast_hourly":if(null==e.hour_index)throw new Error("hour_index is required for forecast_hourly");return a("hourly",e.hour_index);default:throw new Error("Invalid date type")}}(t,e)}))})),a}class p{constructor(t,e,a={}){this.apiCaller=e??h,this.map=null,this.velocityLayer=null,this.temperatureRenderer=null,this.precipitationRenderer=null,this.layerControl=null,this.isUpdating=!1,this.lastZoom=null,this.updateTimeout=null,this.currentGrid={bounds:null,grid:[],gridPointsMap:null,dx:null,dy:null,nx:null,ny:null},this.gridsMap=null,this.eventHandlers={moveend:null,zoomend:null,click:null},this.handlersPaused=!1,this.options={randomData:a.randomData??!0,demoMode:a.demoMode??!0,center:a.center||[42.8,-8],zoom:a.zoom||8,minZoom:a.minZoom||3,maxZoom:a.maxZoom||18,pointDistance:a.pointDistance||null,maxGridPoints:a.maxGridPoints||600,mapAdjustment:a.mapAdjustment||0,windyParameters:{...this.getDefaultWindyParameters(),...a.windyParams},dateType:a.dateType||"current",start_date:a.start_date||null,end_date:a.end_date||null,hour_index:a.hour_index||null},this.initialize(t)}initialize(t){if("string"==typeof t)this.map=L.map(t,{center:this.options.center,zoom:this.options.zoom});else{if(!(t instanceof L.Map))throw new Error("Invalid mapId. It should be a string or an instance of L.Map");this.map=t}if(this.setupBaseLayers(),this.currentGrid.gridPointsMap=new Map,this.gridsMap=new Map,this.initializeTemperatureLayer(),this.initializePrecipitationLayer(),this.initializeWindLayer(),this.options.demoMode){const t={Temperature:this.temperatureRenderer.canvasLayer,Precipitation:this.precipitationRenderer.canvasLayer,Wind:this.velocityLayer};L.control.layers(null,t,{position:"topleft"}).addTo(this.map)}this.initializeEventHandlers(),this.addLayerControlListeners()}getDefaultWindyParameters(){return{minVelocity:0,maxVelocity:10,velocityScale:.005,particleAge:90,lineWidth:1,particleMultiplier:1/300,frameRate:15,colorScale:["rgb(0, 0, 128)","rgb(0, 0, 255)","rgb(75, 0, 130)","rgb(138, 43, 226)","rgb(255, 0, 255)","rgb(255, 0, 200)","rgb(255, 0, 150)","rgb(255, 0, 100)","rgb(255, 0, 50)","rgb(255, 0, 0)"]}}getPointDistanceFromBounds(t){return d.calculateOptimalPointDistance(t,this.options.maxGridPoints)}getPointDistanceFromZoom(t){return t<=7?1:t>7&&t<=8?.5:t>8&&t<=9?.25:t>9&&t<11?.125:.0625}getWeatherDataAt(t,e){const{gridPointsMap:a,dx:i,dy:n,nx:o,ny:r,bounds:s}=this.currentGrid,l=s.getNorthWest().lat,h=s.getSouthWest().lng,p=Math.floor((l-t)/n),c=Math.floor((e-h)/i);if(p<0||p>=r-1||c<0||c>=o-1)throw new Error("Coordinates outside grid bounds");const u=[{lat:l-p*n,lng:h+c*i},{lat:l-p*n,lng:h+(c+1)*i},{lat:l-(p+1)*n,lng:h+c*i},{lat:l-(p+1)*n,lng:h+(c+1)*i}].map((({lat:t,lng:e})=>a.get(d.generatePointKey(t,e))));if(u.some((t=>!t)))throw new Error("Missing grid points for interpolation");const[m,y,g,_]=u,[f,v]=[m.longitude,y.longitude],[w,M]=[m.latitude,g.latitude];if(this.options.demoMode){const t=L.rectangle([[w,f],[M,v]],{color:"red",weight:1}).addTo(this.map);this.map.once("click",(()=>this.map.removeLayer(t)))}const D=(a,i,n,o)=>(M-t)/(M-w)*((v-e)/(v-f)*a+(e-f)/(v-f)*i)+(t-w)/(M-w)*((v-e)/(v-f)*n+(e-f)/(v-f)*o),b=D(m.weatherData.temperature,y.weatherData.temperature,g.weatherData.temperature,_.weatherData.temperature),x=D(m.weatherData.precipitation,y.weatherData.precipitation,g.weatherData.precipitation,_.weatherData.precipitation),P=D(m.weatherData.wind.speed,y.weatherData.wind.speed,g.weatherData.wind.speed,_.weatherData.wind.speed),C=D(m.weatherData.wind.direction,y.weatherData.wind.direction,g.weatherData.wind.direction,_.weatherData.wind.direction);return{temperature:b,precipitation:x,precipitationProb:D(m.weatherData.precipitation_prob,y.weatherData.precipitation_prob,g.weatherData.precipitation_prob,_.weatherData.precipitation_prob),wind:{speed:P,direction:C}}}setupBaseLayers(){const t=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"),e=L.tileLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"),a=L.tileLayer("http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png"),i=L.tileLayer("http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png");this.layerControl=L.control.layers({Satellite:e,OpenStreetMap:t,"Carto Db Dark":a,cartoDbLight:i},null,{position:"topleft"}).addTo(this.map),a.addTo(this.map)}destroy(){if(this.layerControl&&this.layerControl._layers)for(let t in this.layerControl._layers){const e=this.layerControl._layers[t];this.map.hasLayer(e.layer)&&this.map.removeLayer(e.layer)}this.layerControl&&(this.map.removeControl(this.layerControl),this.layerControl=null),this.map.off("moveend",this.eventHandlers.moveend),this.map.off("zoomend",this.eventHandlers.zoomend),this.map.off("click",this.eventHandlers.click),this.updateTimeout&&(clearTimeout(this.updateTimeout),this.updateTimeout=null),this.currentGrid={bounds:null,grid:[],gridPointsMap:null,dx:null,dy:null,nx:null,ny:null},this.gridsMap=null,this.isUpdating=!1,this.lastZoom=null}debounce(t,e){let a;return function(...i){clearTimeout(a),a=setTimeout((()=>t.apply(this,i)),e)}}initializeEventHandlers(){const t=this.map;this.eventHandlers.moveend=this.debounce((()=>{if(0===this.gridsMap.size)return;var e=t.getBounds();const a=this.currentGrid.bounds;if(!(a.contains(e.getNorthEast())&&a.contains(e.getSouthWest()))){const e=d.getMapBoundsCoordinates(t,this.options.mapAdjustment);this.currentGrid=d.gridBuilder(t,this.options.pointDistance,e,this.currentGrid.gridPointsMap,this.options.demoMode),this.forceUpdate()}}),300),this.eventHandlers.zoomend=this.debounce((async()=>{if(0===this.gridsMap.size)return;const e=t.getBounds(),a=this.currentGrid.bounds,i=a.contains(e.getNorthEast())&&a.contains(e.getSouthWest()),n=d.getMapBoundsCoordinates(t,this.options.mapAdjustment),o=this.getPointDistanceFromBounds(n),r=o!==this.options.pointDistance;i&&!r||(this.options.pointDistance=o,this.currentGrid=d.gridBuilder(t,this.options.pointDistance,n,this.currentGrid.gridPointsMap,this.options.demoMode),this.forceUpdate())}),300),this.eventHandlers.click=this.debounce((e=>{var a=e.latlng.lat,i=e.latlng.lng;const n={grid:[new o(a,i)]},r={randomData:this.options.randomData,dateType:this.options.dateType};if(this.options.demoMode){const t=this.fetchWeatherData(n,r);console.log("API data:\n",t)}const s=this.getWeatherDataAt(a,i);L.popup({closeOnClick:!0,className:"windelsis-popup"}).setLatLng(e.latlng).setContent(`<b>Coordinates:</b><br>Lat: ${a.toFixed(5)}<br>Lng: ${i.toFixed(5)}<br><b>Temperature:</b> ${s.temperature.toFixed(2)}°C<br><b>Precipitation:</b> ${s.precipitation.toFixed(2)} mm<br><b>Wind:</b> ${s.wind.speed.toFixed(2)} m/s, ${s.wind.direction.toFixed(0)}°<br><b>Precipitation Probability:</b> ${s.precipitationProb.toFixed(2)}%`).openOn(t)}),300),t.on("moveend",this.eventHandlers.moveend),t.on("zoomend",this.eventHandlers.zoomend),t.on("click",this.eventHandlers.click)}pauseHandlers(){this.handlersPaused||(this.map.off("moveend",this.eventHandlers.moveend),this.map.off("zoomend",this.eventHandlers.zoomend),this.handlersPaused=!0,console.log("Handlers paused"))}resumeHandlers(){this.handlersPaused&&(this.map.on("moveend",this.eventHandlers.moveend),this.map.on("zoomend",this.eventHandlers.zoomend),this.handlersPaused=!1,console.log("Handlers resumed"))}toggleUpdates(){return this.handlersPaused?this.resumeHandlers():this.pauseHandlers(),this.handlersPaused}addLayerControlListeners(){this.map.on("overlayadd",(t=>{t.layer===this.temperatureRenderer.canvasLayer?(this.map.hasLayer(this.precipitationRenderer.canvasLayer)&&this.map.removeLayer(this.precipitationRenderer.canvasLayer),this.velocityLayer.setOptions({colorScale:["rgb(255, 255, 255)"]}),this.map.hasLayer(this.velocityLayer)&&(this.velocityLayer.remove(),this.velocityLayer.addTo(this.map))):t.layer===this.precipitationRenderer.canvasLayer&&(this.map.hasLayer(this.temperatureRenderer.canvasLayer)&&this.map.removeLayer(this.temperatureRenderer.canvasLayer),this.velocityLayer.setOptions({colorScale:["rgb(255, 255, 255)"]}),this.map.hasLayer(this.velocityLayer)&&(this.velocityLayer.remove(),this.velocityLayer.addTo(this.map)))})),this.map.on("overlayremove",(t=>{t.layer!==this.temperatureRenderer.canvasLayer&&t.layer!==this.precipitationRenderer.canvasLayer||(this.setWindyParameters(this.options.windyParameters),this.map.hasLayer(this.velocityLayer)&&(this.velocityLayer.remove(),this.velocityLayer.addTo(this.map)))}))}initializeTemperatureLayer(){this.temperatureRenderer=new n(this.map,[],{pixelSize:5,opacity:.3,controlName:"Temperature Layer",colorScale:i.temperature,layerControl:this.layerControl,demoMode:this.options.demoMode}),this.temperatureRenderer.canvasLayer=this.temperatureRenderer.init()}initializePrecipitationLayer(){this.precipitationRenderer=new n(this.map,[],{pixelSize:5,opacity:.3,controlName:"Precipitation Layer",colorScale:i.precipitation,layerControl:this.layerControl,demoMode:this.options.demoMode}),this.precipitationRenderer.canvasLayer=this.precipitationRenderer.init()}initializeWindLayer(){this.velocityLayer=L.velocityLayer({displayValues:!0,displayOptions:{velocityType:"Global Wind",emptyString:"No velocity data"}}),this.layerControl.addOverlay(this.velocityLayer,"Wind Layer"),this.velocityLayer.setOptions(this.options.windyParameters)}forceUpdate(){this.updateWeatherData().then((()=>{console.log(this.currentGrid.grid),this.updateTemperatureData(),this.updatePrecipitationData(),this.updateWindData(),this.currentGrid.grid=this.currentGrid.grid.filter((t=>t.isStale())),this.gridsMap.set(this.gridKey,this.currentGrid)}))}async updateWeatherData(){const t=await this.fetchWeatherData(this.currentGrid,this.options);this.options.randomData||t.forEach(((t,e)=>this.currentGrid.grid[e].setWeatherData(t)))}updateTemperatureData(){this.temperatureRenderer.update(d.tempDataBuilder(this.currentGrid))}updatePrecipitationData(){this.precipitationRenderer.update(d.precipDataBuilder(this.currentGrid))}updateWindData(){this.velocityLayer.setData(d.windyDataBuilder(this.currentGrid,this.options))}getCurrentData(){const t="current";if(this.gridsMap.has(t))this.currentGrid=this.gridsMap.get(t);else{const e=d.getMapBoundsCoordinates(this.map,this.options.mapAdjustment);this.options.pointDistance=this.getPointDistanceFromBounds(e);let a=d.gridBuilder(this.map,this.options.pointDistance,d.getMapBoundsCoordinates(this.map,this.options.mapAdjustment),new Map,this.options.demoMode);this.gridsMap.set(t,a),this.currentGrid=this.gridsMap.get(t)}return this.setDateType("current",{key:t})}getForecastData(t,e){const a=`forecast_${t}_${e}`;if(this.gridsMap.has(a))this.currentGrid=this.gridsMap.get(a);else{const t=d.getMapBoundsCoordinates(this.map,this.options.mapAdjustment);this.options.pointDistance=this.getPointDistanceFromBounds(t);const e=d.gridBuilder(this.map,this.options.pointDistance,d.getMapBoundsCoordinates(this.map,this.options.mapAdjustment),new Map,this.options.demoMode);this.gridsMap.set(a,e),this.currentGrid=e}return this.setDateType("forecast",{key:a,start_date:t,end_date:e})}getHourlyForecast(t,e,a){const i=`forecast_hourly_${t}_${e}_${a}`;if(this.gridsMap.has(i))this.currentGrid=this.gridsMap.get(i);else{const t=d.getMapBoundsCoordinates(this.map,this.options.mapAdjustment);this.options.pointDistance=this.getPointDistanceFromBounds(t);const e=d.gridBuilder(this.map,this.options.pointDistance,d.getMapBoundsCoordinates(this.map,this.options.mapAdjustment),new Map,this.options.demoMode);this.gridsMap.set(i,e),this.currentGrid=e}return this.setDateType("forecast_hourly",{key:i,start_date:t,end_date:e,hour_index:a})}setDateType(t,e={}){return this.options.dateType=t,"forecast"===t||"forecast_hourly"===t?(this.options.start_date=e.start_date,this.options.end_date=e.end_date,this.options.hour_index=e.hour_index||null):(this.options.start_date=null,this.options.end_date=null,this.options.hour_index=null),this.gridKey=e.key,this.forceUpdate()}setWindyParameters(t){this.options.windyParameters={...this.options.windyParameters,...t},this.velocityLayer&&this.velocityLayer.setOptions(this.options.windyParameters)}showWeatherPopup(t,e){const a=d.generatePointKey(t,e),i=this.currentGrid.gridPointsMap.get(a);if(!i)return void console.error("no gridPoint found for the given coordinates:",t,e);const{temperature:n,wind:o,timestamp:r}=i.weatherData,s=`\n      <div>\n        <h4>Datos Meteorológicos</h4>\n        <p><strong>Coordenadas:</strong> Lat: ${t.toFixed(4)}, Lng: ${e.toFixed(4)}</p>\n        <p><strong>Temperatura:</strong> ${null!==n?n+" °C":"No disponible"}</p>\n        <p><strong>Viento:</strong> ${null!==o.speed?o.speed+" m/s":"No disponible"} \n           ${null!==o.direction?" - "+o.direction+"°":""}</p>\n        ${r?`<p><strong>Actualizado:</strong> ${new Date(r).toLocaleString()}</p>`:""}\n      </div>\n    `;L.popup({closeOnClick:!0,autoClose:!1}).setLatLng([t,e]).setContent(s).openOn(this.map)}async fetchWeatherData(t,e){const a=t.grid||t,i={dateType:e.dateType,start_date:e.start_date,end_date:e.end_date,hour_index:e.hour_index};if(e.randomData)d.generateRandomGridData(a);else try{let t=[];return a&&a.length>0&&(t=await this.apiCaller(a,i)),t}catch(t){throw console.error("Fetching weather data failed:",t),t}}}})(),e})()));